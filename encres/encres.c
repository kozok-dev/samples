#include <stdio.h>
#include <windows.h>

BYTE g_decrescode[] = {
0x55, 0x8b, 0xec, 0x8b, 0x45, 0x24, 0x83, 0xec, 0x14, 0x53, 0x8b, 0x18, 0x03, 0x5d, 0x08, 0x56,
0x03, 0x5d, 0x0c, 0x80, 0x7d, 0x20, 0x00, 0x57, 0x75, 0x2e, 0x8a, 0x45, 0x14, 0x84, 0xc0, 0x74,
0x3d, 0x3c, 0x01, 0x0f, 0x85, 0xc1, 0x00, 0x00, 0x00, 0x8b, 0x45, 0x10, 0x83, 0x38, 0x0e, 0x0f,
0x85, 0xb5, 0x00, 0x00, 0x00, 0x66, 0xc7, 0x45, 0x0c, 0x00, 0x00, 0x66, 0x8b, 0x4d, 0x0c, 0x66,
0x89, 0x4b, 0x0e, 0xe9, 0xa9, 0x00, 0x00, 0x00, 0x80, 0x7d, 0x14, 0x01, 0x0f, 0x85, 0x98, 0x00,
0x00, 0x00, 0x8b, 0x4d, 0x10, 0x83, 0x39, 0x03, 0x0f, 0x85, 0x8c, 0x00, 0x00, 0x00, 0x80, 0x7d,
0x20, 0x00, 0x75, 0x08, 0x66, 0xc7, 0x45, 0x0c, 0x00, 0x00, 0xeb, 0x06, 0x66, 0xc7, 0x45, 0x0c,
0x00, 0x00, 0x66, 0x8b, 0x55, 0x0c, 0x66, 0x89, 0x53, 0x0e, 0x8b, 0x75, 0x0c, 0x0f, 0xb7, 0xc6,
0x83, 0xc3, 0x10, 0x33, 0xc9, 0x8d, 0x50, 0xff, 0x85, 0xd2, 0x89, 0x5d, 0xf8, 0x89, 0x4d, 0xfc,
0x7e, 0x65, 0x8d, 0x51, 0x01, 0x3b, 0xd0, 0x89, 0x55, 0xf4, 0x73, 0x36, 0x8d, 0x04, 0xd3, 0x90,
0x8b, 0x34, 0xcb, 0x3b, 0x30, 0x76, 0x18, 0x8b, 0x38, 0x8b, 0x54, 0xcb, 0x04, 0x89, 0x3c, 0xcb,
0x8b, 0x78, 0x04, 0x89, 0x7c, 0xcb, 0x04, 0x89, 0x50, 0x04, 0x8b, 0x55, 0xf4, 0x89, 0x30, 0x8b,
0x75, 0x0c, 0x0f, 0xb7, 0xfe, 0x83, 0xc2, 0x01, 0x83, 0xc0, 0x08, 0x3b, 0xd7, 0x89, 0x55, 0xf4,
0x72, 0xce, 0x8b, 0x4d, 0xfc, 0x83, 0xc1, 0x01, 0x0f, 0xb7, 0xc6, 0x89, 0x4d, 0xfc, 0x0f, 0xb7,
0xc9, 0x8d, 0x50, 0xff, 0x3b, 0xca, 0x7c, 0xaa, 0xeb, 0x0d, 0x0f, 0xb7, 0x53, 0x0e, 0x89, 0x55,
0x0c, 0x83, 0xc3, 0x10, 0x89, 0x5d, 0xf8, 0x33, 0xc0, 0x66, 0x39, 0x45, 0x0c, 0x89, 0x45, 0xfc,
0x0f, 0x86, 0xcc, 0x01, 0x00, 0x00, 0x8a, 0x4d, 0x14, 0x8b, 0x7d, 0x10, 0x0f, 0xbe, 0xd1, 0x8d,
0x14, 0x97, 0x89, 0x55, 0xf0, 0xeb, 0x0f, 0xeb, 0x07, 0x8d, 0xa4, 0x24, 0x00, 0x00, 0x00, 0x00,
0x8b, 0x7d, 0x10, 0x8a, 0x4d, 0x14, 0x80, 0x7d, 0x20, 0x00, 0x8b, 0x75, 0xf0, 0x0f, 0xb7, 0xc0,
0x8d, 0x14, 0xc3, 0x8b, 0x02, 0x89, 0x55, 0xf4, 0x89, 0x06, 0x74, 0x66, 0x84, 0xc9, 0x75, 0x0b,
0x83, 0x3f, 0x03, 0x0f, 0x85, 0x76, 0x01, 0x00, 0x00, 0xeb, 0x78, 0x80, 0xf9, 0x01, 0x75, 0x73,
0x8b, 0x75, 0x18, 0x8b, 0x0e, 0x8b, 0x55, 0x24, 0x8b, 0x42, 0x14, 0x51, 0x6a, 0x00, 0xff, 0xd0,
0x8b, 0x4d, 0x24, 0x8b, 0x51, 0x04, 0x50, 0xff, 0xd2, 0xd1, 0xe8, 0xb9, 0x00, 0x00, 0x00, 0x00,
0x0f, 0x84, 0x49, 0x01, 0x00, 0x00, 0x8b, 0x57, 0x04, 0x8d, 0xa4, 0x24, 0x00, 0x00, 0x00, 0x00,
0x8b, 0x3c, 0x8e, 0x0f, 0xb7, 0x3f, 0x3b, 0xd7, 0x0f, 0x84, 0x31, 0x01, 0x00, 0x00, 0x83, 0xc1,
0x01, 0x3b, 0xc8, 0x72, 0xeb, 0x85, 0xc9, 0x0f, 0x84, 0x22, 0x01, 0x00, 0x00, 0x8b, 0x55, 0xf4,
0xeb, 0x24, 0x84, 0xc9, 0x75, 0x1d, 0x8b, 0x07, 0x83, 0xf8, 0x03, 0x0f, 0x84, 0x0e, 0x01, 0x00,
0x00, 0x83, 0xf8, 0x10, 0x0f, 0x84, 0x05, 0x01, 0x00, 0x00, 0x83, 0xf8, 0x18, 0x0f, 0x84, 0xfc,
0x00, 0x00, 0x00, 0x8b, 0x75, 0x18, 0x8b, 0x4a, 0x04, 0x81, 0xe1, 0xff, 0xff, 0xff, 0x7f, 0xf6,
0x42, 0x07, 0x80, 0x74, 0x35, 0x80, 0x7d, 0x14, 0x02, 0x0f, 0x8d, 0xe0, 0x00, 0x00, 0x00, 0x8b,
0x45, 0x24, 0x8b, 0x55, 0x20, 0x50, 0x8b, 0x45, 0xfc, 0x52, 0x0f, 0xb6, 0x55, 0x14, 0x50, 0x8b,
0x45, 0x10, 0x80, 0xc2, 0x01, 0x56, 0x52, 0x50, 0x51, 0x8b, 0x4d, 0x08, 0x51, 0xe8, 0xfe, 0xfd,
0xff, 0xff, 0x83, 0xc4, 0x20, 0xe9, 0xb5, 0x00, 0x00, 0x00, 0x8b, 0x55, 0x24, 0x8b, 0x32, 0x8b,
0x45, 0x08, 0x03, 0xc6, 0x8b, 0x7c, 0x08, 0x04, 0x03, 0xc1, 0x8b, 0x00, 0x03, 0xc6, 0x66, 0x83,
0x7d, 0x1c, 0x00, 0x75, 0x7f, 0x8b, 0x4d, 0x10, 0x83, 0x39, 0x0e, 0x75, 0x77, 0x0f, 0xb7, 0x48,
0x04, 0x0f, 0xb7, 0xc9, 0x83, 0xc0, 0x06, 0x33, 0xff, 0x33, 0xf6, 0x85, 0xc9, 0x89, 0x4d, 0xec,
0x76, 0x7d, 0x83, 0xc0, 0x0c, 0x89, 0x45, 0xf4, 0x8b, 0x5d, 0x18, 0x8b, 0x03, 0x8b, 0x4d, 0x24,
0x8d, 0x56, 0x02, 0x52, 0x8b, 0x51, 0x14, 0x50, 0x6a, 0x00, 0xff, 0xd2, 0x50, 0x8b, 0x45, 0x24,
0x8b, 0x48, 0x08, 0xff, 0xd1, 0x85, 0xc0, 0x74, 0x72, 0x8b, 0x55, 0x18, 0x89, 0x03, 0xd1, 0xee,
0x8d, 0x1c, 0x70, 0x8b, 0x02, 0x8b, 0x75, 0x24, 0x8b, 0x4e, 0x14, 0x50, 0x6a, 0x00, 0xff, 0xd1,
0x8b, 0x56, 0x04, 0x50, 0xff, 0xd2, 0x8b, 0xf0, 0x8b, 0x45, 0xf4, 0x66, 0x8b, 0x08, 0x83, 0xc0,
0x0e, 0x83, 0xc7, 0x01, 0x3b, 0x7d, 0xec, 0x66, 0x89, 0x0b, 0x89, 0x45, 0xf4, 0x72, 0xa9, 0x8b,
0x5d, 0xf8, 0xeb, 0x1b, 0x33, 0xf6, 0x85, 0xff, 0x76, 0x15, 0x8d, 0x9b, 0x00, 0x00, 0x00, 0x00,
0x8a, 0x14, 0x30, 0xf6, 0xd2, 0x88, 0x14, 0x30, 0x83, 0xc6, 0x01, 0x3b, 0xf7, 0x72, 0xf1, 0x8b,
0x45, 0xfc, 0x83, 0xc0, 0x01, 0x66, 0x3b, 0x45, 0x0c, 0x89, 0x45, 0xfc, 0x0f, 0x82, 0x4e, 0xfe,
0xff, 0xff, 0x5f, 0x5e, 0xb0, 0x01, 0x5b, 0x8b, 0xe5, 0x5d, 0xc3, 0x5f, 0x5e, 0x32, 0xc0, 0x5b,
0x8b, 0xe5, 0x5d, 0xc3, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
0x83, 0xec, 0x10, 0x53, 0x8b, 0x5c, 0x24, 0x18, 0x8b, 0x0b, 0x8b, 0x41, 0x3c, 0x03, 0xc1, 0x8b,
0x88, 0x88, 0x00, 0x00, 0x00, 0x85, 0xc9, 0x55, 0x56, 0x57, 0x0f, 0xb7, 0x78, 0x06, 0xc7, 0x44,
0x24, 0x10, 0x01, 0x00, 0x00, 0x00, 0x0f, 0x86, 0xb1, 0x00, 0x00, 0x00, 0x05, 0xf8, 0x00, 0x00,
0x00, 0x33, 0xd2, 0x66, 0x85, 0xff, 0x0f, 0x86, 0xa1, 0x00, 0x00, 0x00, 0x83, 0xc0, 0x08, 0x90,
0x8b, 0x70, 0x04, 0x3b, 0xce, 0x72, 0x08, 0x8b, 0x28, 0x03, 0xee, 0x3b, 0xcd, 0x72, 0x17, 0x83,
0xc2, 0x01, 0x83, 0xc0, 0x28, 0x66, 0x3b, 0xd7, 0x72, 0xe6, 0x8b, 0x44, 0x24, 0x10, 0x5f, 0x5e,
0x5d, 0x5b, 0x83, 0xc4, 0x10, 0xc3, 0x8b, 0x43, 0x14, 0x6a, 0x00, 0x6a, 0x00, 0xff, 0xd0, 0x8b,
0x4b, 0x10, 0x50, 0xff, 0xd1, 0x85, 0xc0, 0x89, 0x44, 0x24, 0x24, 0x75, 0x08, 0x5f, 0x5e, 0x5d,
0x5b, 0x83, 0xc4, 0x10, 0xc3, 0x53, 0x6a, 0x00, 0x6a, 0x00, 0x8d, 0x54, 0x24, 0x30, 0x52, 0x6a,
0x00, 0x8d, 0x44, 0x24, 0x28, 0x50, 0x6a, 0x00, 0x56, 0xe8, 0x72, 0xfc, 0xff, 0xff, 0x83, 0xc4,
0x20, 0x84, 0xc0, 0x74, 0x1e, 0x53, 0x6a, 0x01, 0x6a, 0x00, 0x8d, 0x4c, 0x24, 0x30, 0x51, 0x6a,
0x00, 0x8d, 0x54, 0x24, 0x28, 0x52, 0x6a, 0x00, 0x56, 0xe8, 0x52, 0xfc, 0xff, 0xff, 0x83, 0xc4,
0x20, 0xeb, 0x08, 0xc7, 0x44, 0x24, 0x10, 0x00, 0x00, 0x00, 0x00, 0x8b, 0x44, 0x24, 0x24, 0x8b,
0x4b, 0x14, 0x50, 0x6a, 0x00, 0xff, 0xd1, 0x8b, 0x53, 0x0c, 0x50, 0xff, 0xd2, 0x8b, 0x44, 0x24,
0x10, 0x5f, 0x5e, 0x5d, 0x5b, 0x83, 0xc4, 0x10, 0xc3, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
0x53, 0x8b, 0x5c, 0x24, 0x04, 0x81, 0xe3, 0x00, 0x00, 0xff, 0xff, 0xb9, 0x05, 0x00, 0x00, 0x00,
0x55, 0x56, 0x57, 0x8b, 0xec, 0x83, 0xec, 0x38, 0xb8, 0x00, 0x00, 0x00, 0x00, 0x66, 0x81, 0x3b,
0x4d, 0x5a, 0x74, 0x12, 0x49, 0x83, 0xf9, 0x00, 0x0f, 0x8e, 0xb6, 0x01, 0x00, 0x00, 0x81, 0xeb,
0x00, 0x00, 0x01, 0x00, 0xeb, 0xe7, 0x8b, 0xd3, 0x03, 0x53, 0x3c, 0x81, 0x3a, 0x50, 0x45, 0x00,
0x00, 0x75, 0xe1, 0xc7, 0x45, 0xf0, 0x47, 0x65, 0x74, 0x50, 0xc7, 0x45, 0xf4, 0x72, 0x6f, 0x63,
0x41, 0xc7, 0x45, 0xf8, 0x64, 0x64, 0x72, 0x65, 0xc7, 0x45, 0xfc, 0x73, 0x73, 0x00, 0x00, 0x8b,
0xc3, 0x03, 0x42, 0x78, 0x83, 0xc0, 0x18, 0x8b, 0x10, 0x89, 0x55, 0xec, 0x8b, 0x50, 0x04, 0x03,
0xd3, 0x89, 0x55, 0xe8, 0x8b, 0x50, 0x0c, 0x03, 0xd3, 0x89, 0x55, 0xe4, 0x8b, 0x50, 0x08, 0x03,
0xd3, 0xb8, 0x00, 0x00, 0x00, 0x00, 0xb9, 0x00, 0x00, 0x00, 0x00, 0x8b, 0xf3, 0x03, 0x34, 0x02,
0x8d, 0x7d, 0xf0, 0xa6, 0x75, 0x07, 0x80, 0x3e, 0x00, 0x74, 0x17, 0xeb, 0xf6, 0x41, 0x3b, 0x4d,
0xec, 0x7c, 0x0a, 0xb8, 0x00, 0x00, 0x00, 0x00, 0xe9, 0x37, 0x01, 0x00, 0x00, 0x83, 0xc0, 0x04,
0xeb, 0xd9, 0xd1, 0xe1, 0x8b, 0x55, 0xe4, 0x03, 0xd1, 0xb8, 0x00, 0x00, 0x00, 0x00, 0x66, 0x8b,
0x02, 0xc1, 0xe0, 0x02, 0x8b, 0x55, 0xe8, 0x03, 0xd0, 0x8b, 0x12, 0x03, 0xd3, 0x89, 0x55, 0xe0,
0xc7, 0x45, 0xf0, 0x47, 0x65, 0x74, 0x50, 0xc7, 0x45, 0xf4, 0x72, 0x6f, 0x63, 0x65, 0xc7, 0x45,
0xf8, 0x73, 0x73, 0x48, 0x65, 0xc7, 0x45, 0xfc, 0x61, 0x70, 0x00, 0x00, 0x8d, 0x45, 0xf0, 0x50,
0x53, 0xff, 0x55, 0xe0, 0x83, 0xf8, 0x00, 0x0f, 0x84, 0xe7, 0x00, 0x00, 0x00, 0x89, 0x45, 0xdc,
0xc7, 0x45, 0xf4, 0x48, 0x65, 0x61, 0x70, 0xc7, 0x45, 0xf8, 0x41, 0x6c, 0x6c, 0x6f, 0xc7, 0x45,
0xfc, 0x63, 0x00, 0x00, 0x00, 0x8d, 0x45, 0xf4, 0x50, 0x53, 0xff, 0x55, 0xe0, 0x83, 0xf8, 0x00,
0x0f, 0x84, 0xbe, 0x00, 0x00, 0x00, 0x89, 0x45, 0xd8, 0xc7, 0x45, 0xf4, 0x48, 0x65, 0x61, 0x70,
0xc7, 0x45, 0xf8, 0x46, 0x72, 0x65, 0x65, 0xc7, 0x45, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x8d, 0x45,
0xf4, 0x50, 0x53, 0xff, 0x55, 0xe0, 0x83, 0xf8, 0x00, 0x0f, 0x84, 0x95, 0x00, 0x00, 0x00, 0x89,
0x45, 0xd4, 0xc7, 0x45, 0xf4, 0x48, 0x65, 0x61, 0x70, 0xc7, 0x45, 0xf8, 0x52, 0x65, 0x41, 0x6c,
0xc7, 0x45, 0xfc, 0x6c, 0x6f, 0x63, 0x00, 0x8d, 0x45, 0xf4, 0x50, 0x53, 0xff, 0x55, 0xe0, 0x83,
0xf8, 0x00, 0x74, 0x70, 0x89, 0x45, 0xd0, 0xc7, 0x45, 0xf4, 0x48, 0x65, 0x61, 0x70, 0xc7, 0x45,
0xf8, 0x53, 0x69, 0x7a, 0x65, 0xc7, 0x45, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x8d, 0x45, 0xf4, 0x50,
0x53, 0xff, 0x55, 0xe0, 0x83, 0xf8, 0x00, 0x74, 0x4b, 0x89, 0x45, 0xcc, 0xc7, 0x45, 0xf0, 0x56,
0x69, 0x72, 0x74, 0xc7, 0x45, 0xf4, 0x75, 0x61, 0x6c, 0x51, 0xc7, 0x45, 0xf8, 0x75, 0x65, 0x72,
0x79, 0xc7, 0x45, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x8d, 0x45, 0xf0, 0x50, 0x53, 0xff, 0x55, 0xe0,
0x83, 0xf8, 0x00, 0x74, 0x1f, 0x6a, 0x1c, 0x8d, 0x4d, 0xe4, 0x51, 0xe8, 0x00, 0x00, 0x00, 0x00,
0xff, 0xd0, 0x8b, 0x45, 0xe8, 0x89, 0x45, 0xc8, 0x8d, 0x45, 0xc8, 0x50, 0xe8, 0x2f, 0xfd, 0xff,
0xff, 0x83, 0xc4, 0x04, 0x8b, 0xe5, 0x5f, 0x5e, 0x5d, 0x5b, 0x83, 0xf8, 0x00, 0x75, 0x01, 0xc3,
0xe9, 0x00, 0x00, 0x00, 0x00};
WORD g_rootcnt, g_icocnt, g_gicocnt, *g_id;
DWORD g_resname[3], g_size;
char g_flag;

void enc_resdata(FILE *f, DWORD sechpos, WORD seccnt, DWORD respos, char d, char flag)
{
	fpos_t fp;
	BYTE c1, c2;
	WORD i, *id;
	DWORD j, k;
	IMAGE_SECTION_HEADER ish;
	IMAGE_RESOURCE_DIRECTORY ird;
	IMAGE_RESOURCE_DIRECTORY_ENTRY irdire, *prdire;
	IMAGE_RESOURCE_DATA_ENTRY irdatae;
	struct {
		WORD idReserved, idType, idCount;
	} gid;
	struct {
		BYTE bWidth, bHeight, bColorCount, bReserved;
		WORD wPlanes, wBitCount;
		DWORD dwBytesInRes;
		WORD nID;
	} gide;

	if (fread(&ird, sizeof(ird), 1, f) < 1) return;

	if (!flag && d == 0 || flag && d == 1 && g_resname[0] == (DWORD)RT_ICON) {
		/* 暗号化するデータをすべて読み込む。*/
		if ((prdire = malloc(sizeof(IMAGE_RESOURCE_DIRECTORY_ENTRY) * ird.NumberOfIdEntries)) == NULL)
			return;
		if (fread(prdire, sizeof(IMAGE_RESOURCE_DIRECTORY_ENTRY), ird.NumberOfIdEntries, f) < ird.NumberOfIdEntries ||
		fseek(f, -sizeof(IMAGE_RESOURCE_DIRECTORY_ENTRY) * ird.NumberOfIdEntries, SEEK_CUR)) {
			free(prdire);
			return;
		}

		/* 暗号化しないデータ昇順で並べ替え。*/
		for (i = 0; i < ird.NumberOfIdEntries - 1; i++)
			for (j = i + 1; j < ird.NumberOfIdEntries; j++) {
				if (flag) {
					c1 = 0;
					for (k = 0; k < _msize(g_id) / sizeof(WORD); k++)
						if (prdire[i].Name == g_id[k]) {
							c1 = 1;
							break;
						}

					c2 = 0;
					for (k = 0; k < _msize(g_id) / sizeof(WORD); k++)
						if (prdire[j].Name == g_id[k]) {
							c2 = 1;
							break;
						}
				} else {
					c1 = prdire[i].Name == (DWORD)RT_ICON || prdire[i].Name == (DWORD)RT_GROUP_ICON ||
					prdire[i].Name == (DWORD)RT_VERSION || prdire[i].Name == (DWORD)RT_MANIFEST;

					c2 = prdire[j].Name == (DWORD)RT_ICON || prdire[j].Name == (DWORD)RT_GROUP_ICON ||
					prdire[j].Name == (DWORD)RT_VERSION || prdire[j].Name == (DWORD)RT_MANIFEST;
				}

				if (c1 && c2 && prdire[i].Name <= prdire[j].Name || c1 && !c2 || !c1 && !c2) continue;
				irdire = prdire[i];
				prdire[i] = prdire[j];
				prdire[j] = irdire;
			}

		/* 暗号化するデータをすべて書き込む。*/
		if (fwrite(prdire, sizeof(IMAGE_RESOURCE_DIRECTORY_ENTRY), ird.NumberOfIdEntries, f) < ird.NumberOfIdEntries ||
		fseek(f, -sizeof(IMAGE_RESOURCE_DIRECTORY_ENTRY) * ird.NumberOfIdEntries - 2, SEEK_CUR)) {
			free(prdire);
			return;
		}

		/* 暗号化しないデータの数を書き込む。*/
		if (flag)
			i = _msize(g_id) / sizeof(WORD);
		else {
			i = 0;
			for (j = 0; j < ird.NumberOfIdEntries; j++)
				if (prdire[j].Name == (DWORD)RT_ICON || prdire[j].Name == (DWORD)RT_GROUP_ICON ||
				prdire[j].Name == (DWORD)RT_VERSION || prdire[j].Name == (DWORD)RT_MANIFEST) i++;
		}
		free(prdire);
		if (fwrite(&i, 2, 1, f) < 1) return;

		fflush(f);

		if (flag) g_icocnt = ird.NumberOfIdEntries;
		else g_rootcnt = ird.NumberOfIdEntries;
	} else if (!flag && d == 1 && g_resname[0] == (DWORD)RT_GROUP_ICON) {
		/* 始めのデータのみ残す。*/
		i = 1;
		if (fseek(f, -2, SEEK_CUR) || fwrite(&i, 2, 1, f) < 1) return;
		fflush(f);

		g_gicocnt = ird.NumberOfIdEntries;
	}

	for (i = 0; i < ird.NumberOfIdEntries; i++) {
		printf("\b\b\b\b\b%5d", i);
		if (fread(&irdire, sizeof(irdire), 1, f) < 1) return;

		/* 暗号化しないデータは飛ばす。*/
		if (flag) {
			if (d == 0) {
				if (irdire.Name != (DWORD)RT_ICON) continue;
			} else if (d == 1) {
				for (j = 0; j < _msize(g_id) / sizeof(WORD); j++)
					if (irdire.Name == g_id[j]) {
						j = 0;
						break;
					}
				if (j == 0) continue;
			}
		} else
			if (d == 0 && irdire.Name == (DWORD)RT_ICON) continue;
		if (d == 0 && (irdire.Name == (DWORD)RT_VERSION || irdire.Name == (DWORD)RT_MANIFEST))
			continue;

		if (fgetpos(f, &fp) || fseek(f, respos + irdire.OffsetToDirectory, SEEK_SET)) return;
		g_resname[d] = irdire.Name;

		if (irdire.DataIsDirectory) {
			if (d < 2) {
				printf("-     ");
				enc_resdata(f, sechpos, seccnt, respos, d + 1, flag);
				printf("\b\b\b\b\b\b");
			}
		} else {
			if (fread(&irdatae, sizeof(irdatae), 1, f) < 1 || fseek(f, sechpos, SEEK_SET)) return;
			for (j = 0; j < seccnt; j++) {
				if (fread(&ish, sizeof(ish), 1, f) < 1) return;
				if (irdatae.OffsetToData >= ish.VirtualAddress &&
				irdatae.OffsetToData < ish.VirtualAddress + ish.Misc.VirtualSize) break;
			}
			if (j >= seccnt ||
			fseek(f, ish.PointerToRawData + irdatae.OffsetToData - ish.VirtualAddress, SEEK_SET))
				return;

			if (g_flag && g_resname[0] == (DWORD)RT_GROUP_ICON) {
				/* EXEアイコンID設定。*/
				if (fread(&gid, 6, 1, f) < 1) return;
				g_flag = 0;
				for (j = 0; j < gid.idCount; j++) {
					if (fread(&gide, 14, 1, f) < 1 ||
					(id = realloc(g_id, g_size + sizeof(WORD))) == NULL) return;
					g_id = id;
					id = g_id + g_size / sizeof(WORD);
					g_size = _msize(g_id);
					*id = gide.nID;
				}
			} else
				/* 暗号化。*/
				for (j = 0; j < irdatae.Size; j++) {
					c1 = fgetc(f);
					if (fseek(f, -1, SEEK_CUR)) return;
					fputc(~c1, f);
					fflush(f);
				}
		}

		if (fsetpos(f, &fp)) return;
	}
}

void main(int argc, char **argv)
{
	int len, i;
	BYTE drcalign, *buf = NULL, *tmp;
	WORD j;
	DWORD size, vsize;
	FILE *f;
	IMAGE_DOS_HEADER idh;
	IMAGE_NT_HEADERS inh, *pnh;
	IMAGE_SECTION_HEADER ish, *psh;

	for (i = 1; i < argc; i++) {
		if ((f = fopen(argv[i], "r+b")) == NULL) continue;

		/* MZチェック。*/
		if (fread(&idh, sizeof(idh), 1, f) < 1 || idh.e_magic != IMAGE_DOS_SIGNATURE) goto procend;

		/* PEチェック。*/
		if (fseek(f, idh.e_lfanew, SEEK_SET) || fread(&inh, sizeof(inh), 1, f) < 1 ||
		inh.Signature != IMAGE_NT_SIGNATURE) goto procend;

		size = inh.OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_RESOURCE].VirtualAddress;
		if (size <= 0) goto procend;

		for (j = 0; j < inh.FileHeader.NumberOfSections; j++) {
			if (fread(&ish, sizeof(ish), 1, f) < 1) goto procend;
			if (size < ish.VirtualAddress || size >= ish.VirtualAddress + ish.Misc.VirtualSize)
				continue;

			/* リソースデータ暗号化(EXEアイコンIDも設定)。*/
			if (fseek(f, ish.PointerToRawData, SEEK_SET)) goto procend;
			g_flag = 1;
			g_id = NULL;
			g_size = 0;
			enc_resdata(f, idh.e_lfanew + sizeof(inh), inh.FileHeader.NumberOfSections,
			ish.PointerToRawData, 0, 0);

			/* リソースデータ暗号化(EXEアイコン以外のアイコンのみ)。*/
			if (fseek(f, ish.PointerToRawData, SEEK_SET)) goto procend;
			enc_resdata(f, idh.e_lfanew + sizeof(inh), inh.FileHeader.NumberOfSections,
			ish.PointerToRawData, 0, 1);

			free(g_id);
			break;
		}
		if (j >= inh.FileHeader.NumberOfSections) goto procend;

		/* 全データ読み込み。*/
		if (fseek(f, 0, SEEK_SET)) goto procend;
		len = filelength(fileno(f));
		if ((buf = malloc(len)) == NULL || fread(buf, 1, len, f) < len ||
		fseek(f, 0, SEEK_SET)) goto procend;

		/* 各種情報ポインタ設定。*/
		pnh = (PIMAGE_NT_HEADERS)&buf[idh.e_lfanew];
		psh = (PIMAGE_SECTION_HEADER)&buf[idh.e_lfanew + sizeof(inh)] + inh.FileHeader.NumberOfSections - 1;	/* 最後のセクション。*/

		/* 変更前のサイズを取得してサイズ変更。*/
		vsize = psh->Misc.VirtualSize;
		if (vsize > psh->SizeOfRawData) vsize = psh->SizeOfRawData;
		drcalign = 16 - (vsize & 15);	/* メモリ上のサイズの16の倍数に足らない値を計算。*/
		psh->Misc.VirtualSize += sizeof(g_decrescode) + drcalign;	/* メモリ上のサイズ情報変更。*/

		if (psh->Misc.VirtualSize > psh->SizeOfRawData) {	/* メモリ上のサイズがファイル上のサイズより大きくなる場合。*/
			/* 足らない分のサイズのFileAlignmentの倍数を計算。*/
			size = (psh->Misc.VirtualSize + inh.OptionalHeader.FileAlignment - 1 & ~(inh.OptionalHeader.FileAlignment - 1)) - psh->SizeOfRawData;

			/* 領域を足らない分だけ追加確保し、各種情報ポインタを再設定して0クリア。*/
			if ((tmp = realloc(buf, len + size)) == NULL) goto procend;
			buf = tmp;
			pnh = (PIMAGE_NT_HEADERS)&buf[idh.e_lfanew];
			psh = (PIMAGE_SECTION_HEADER)&buf[idh.e_lfanew + sizeof(inh)] + inh.FileHeader.NumberOfSections - 1;
			memset(buf + len, 0, size);

			psh->SizeOfRawData += size;	/* ファイル上のサイズ情報変更。*/

			len += size;
		}

		pnh->OptionalHeader.SizeOfCode = psh->SizeOfRawData;	/* コードサイズ変更。*/
		pnh->OptionalHeader.BaseOfCode = psh->VirtualAddress;	/* コードの位置変更。*/
		/* メモリ上のサイズをSectionAlignmentの倍数になるように変更。*/
		pnh->OptionalHeader.SizeOfImage = psh->VirtualAddress + (psh->Misc.VirtualSize + inh.OptionalHeader.SectionAlignment - 1 & ~(inh.OptionalHeader.SectionAlignment - 1));

		/* リソースデータ複合化コードを埋め込む。*/
		*(WORD *)&g_decrescode[0x39] = g_gicocnt;	/* RT_GROUP_ICONの数。*/
		*(WORD *)&g_decrescode[0x68] = g_rootcnt;	/* ルートのデータの数。*/
		*(WORD *)&g_decrescode[0x70] = g_icocnt;	/* RT_ICONの数。*/
		*(DWORD *)&g_decrescode[0x5d1] = inh.OptionalHeader.AddressOfEntryPoint - psh->VirtualAddress - (vsize + 0x5d5 + drcalign);	/* jmp エントリポイント */
		tmp = &buf[psh->PointerToRawData + vsize];
		memset(tmp, 0, drcalign);
		memcpy(tmp + drcalign, g_decrescode, sizeof(g_decrescode));

		pnh->OptionalHeader.AddressOfEntryPoint = psh->VirtualAddress + vsize + 0x3e0 + drcalign;	/* エントリポイント変更。*/

		fwrite(buf, 1, len, f);

procend:
		free(buf);
		fclose(f);
	}
}
